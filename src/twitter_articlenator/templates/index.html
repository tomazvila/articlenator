{% extends "base.html" %}

{% block title %}Article to PDF Converter{% endblock %}

{% block content %}
<h1>Article to PDF</h1>
<p>Paste article links below (one per line) to convert them to e-reader friendly PDFs.</p>
<p class="supported-sources">Supported: Twitter/X, Blog articles (Bear Blog, Substack, etc.)</p>

<form id="convert-form" method="post" action="/api/convert">
    <div class="form-group">
        <label for="links-input">Article Links:</label>
        <textarea
            id="links-input"
            name="links"
            rows="10"
            placeholder="https://x.com/user/status/123456789
https://example.bearblog.dev/my-article/
https://substack.com/@author/post-title"
        ></textarea>
    </div>
    <div class="button-group">
        <button type="submit" id="convert-btn">Convert to PDF</button>
        <button type="button" id="clear-btn" class="secondary">Clear</button>
    </div>
</form>

<div id="status" class="status-message" style="display: none;">
    <span class="spinner"></span>
    <span id="status-text">Processing...</span>
</div>

<div id="progress-details" class="progress-section" style="display: none;">
    <div class="progress-bar-container">
        <div id="progress-bar" class="progress-bar" style="width: 0%"></div>
    </div>
    <div id="progress-info" class="progress-info"></div>
    <ul id="progress-list" class="progress-list"></ul>
</div>

<div id="results" class="results-section" style="display: none;">
    <h2>Generated PDFs</h2>
    <ul id="download-list"></ul>
</div>

<div id="warning" class="warning-message" style="display: none;">
    <strong>Warning:</strong>
    <pre id="warning-text"></pre>
</div>

<div id="error" class="error-message" style="display: none;">
    <strong>Error:</strong>
    <pre id="error-text"></pre>
</div>

<script>
// Persist textarea content to localStorage
const linksInput = document.getElementById('links-input');
const STORAGE_KEY = 'articlenator_links';

// Restore saved content on page load
const savedLinks = localStorage.getItem(STORAGE_KEY);
if (savedLinks) {
    linksInput.value = savedLinks;
}

// Save on every input change
linksInput.addEventListener('input', () => {
    localStorage.setItem(STORAGE_KEY, linksInput.value);
});

// Also save on blur (when leaving the field)
linksInput.addEventListener('blur', () => {
    localStorage.setItem(STORAGE_KEY, linksInput.value);
});

// Browser notifications
function requestNotificationPermission() {
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
    }
}

function sendNotification(title, body) {
    if ('Notification' in window && Notification.permission === 'granted') {
        const notification = new Notification(title, {
            body: body,
            icon: '/static/icon-192.png',
            tag: 'pdf-ready'
        });
        // Auto-close after 5 seconds
        setTimeout(() => notification.close(), 5000);
        // Focus window when clicked
        notification.onclick = () => {
            window.focus();
            notification.close();
        };
    }
}

// Clear button
document.getElementById('clear-btn').addEventListener('click', () => {
    linksInput.value = '';
    localStorage.removeItem(STORAGE_KEY);
    document.getElementById('results').style.display = 'none';
    document.getElementById('warning').style.display = 'none';
    document.getElementById('error').style.display = 'none';
    document.getElementById('progress-details').style.display = 'none';
    document.getElementById('progress-list').innerHTML = '';
    document.getElementById('progress-bar').style.width = '0%';
});

document.getElementById('convert-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    // Request notification permission on first submit
    requestNotificationPermission();

    const form = e.target;
    const resultsDiv = document.getElementById('results');
    const errorDiv = document.getElementById('error');
    const errorText = document.getElementById('error-text');
    const warningDiv = document.getElementById('warning');
    const warningText = document.getElementById('warning-text');
    const statusDiv = document.getElementById('status');
    const statusText = document.getElementById('status-text');
    const progressDetails = document.getElementById('progress-details');
    const progressBar = document.getElementById('progress-bar');
    const progressInfo = document.getElementById('progress-info');
    const progressList = document.getElementById('progress-list');
    const downloadList = document.getElementById('download-list');
    const submitBtn = document.getElementById('convert-btn');

    // Reset UI
    resultsDiv.style.display = 'none';
    errorDiv.style.display = 'none';
    warningDiv.style.display = 'none';
    progressDetails.style.display = 'none';
    progressList.innerHTML = '';
    downloadList.innerHTML = '';
    submitBtn.disabled = true;
    statusDiv.style.display = 'flex';
    statusText.textContent = 'Starting...';

    try {
        // Use streaming endpoint for real-time progress
        const response = await fetch('/api/convert/stream', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: new URLSearchParams(new FormData(form))
        });

        // Check for non-stream error responses
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
            const data = await response.json();
            if (data.error) {
                errorDiv.style.display = 'block';
                errorText.textContent = data.error;
                if (data.setup_url) {
                    const link = document.createElement('a');
                    link.href = data.setup_url;
                    link.textContent = ' Go to setup →';
                    errorText.appendChild(link);
                }
                return;
            }
        }

        // Process SSE stream
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';

        progressDetails.style.display = 'block';

        while (true) {
            const {value, done} = await reader.read();
            if (done) break;

            buffer += decoder.decode(value, {stream: true});
            const lines = buffer.split('\n\n');
            buffer = lines.pop();  // Keep incomplete data

            for (const line of lines) {
                if (line.startsWith('data: ')) {
                    const data = JSON.parse(line.slice(6));
                    console.log('SSE event:', data);

                    if (data.type === 'start') {
                        statusText.textContent = `Processing ${data.total} link(s)...`;
                        progressInfo.textContent = `0 / ${data.total}`;
                    } else if (data.type === 'progress') {
                        const percent = (data.current / data.total) * 100;
                        progressBar.style.width = `${percent}%`;
                        progressInfo.textContent = `${data.current} / ${data.total}`;

                        // Update or add list item
                        let li = document.getElementById(`progress-${data.current}`);
                        if (!li) {
                            li = document.createElement('li');
                            li.id = `progress-${data.current}`;
                            progressList.appendChild(li);
                        }

                        if (data.status === 'processing') {
                            li.className = 'progress-item processing';
                            li.innerHTML = `<span class="status-icon">⏳</span> ${data.url}`;
                            statusText.textContent = `Processing: ${data.url.substring(0, 50)}...`;
                        } else if (data.status === 'success') {
                            li.className = 'progress-item success';
                            li.innerHTML = `<span class="status-icon">✓</span> ${data.title || data.url}`;
                        } else if (data.status === 'failed') {
                            li.className = 'progress-item failed';
                            li.innerHTML = `<span class="status-icon">✗</span> ${data.url}<br><small class="error-detail">${data.error}</small>`;
                        }
                    } else if (data.type === 'generating_pdf') {
                        statusText.textContent = 'Generating PDF...';
                        progressBar.style.width = '100%';
                    } else if (data.type === 'complete') {
                        statusDiv.style.display = 'none';
                        resultsDiv.style.display = 'block';

                        const li = document.createElement('li');
                        const a = document.createElement('a');
                        a.href = `/download/${data.filename}`;
                        if (data.summary) {
                            a.textContent = `Download PDF (${data.summary.succeeded} article${data.summary.succeeded !== 1 ? 's' : ''})`;
                        } else {
                            a.textContent = 'Download PDF';
                        }
                        li.appendChild(a);
                        downloadList.appendChild(li);

                        // Show summary
                        if (data.summary) {
                            const summaryLi = document.createElement('li');
                            summaryLi.className = 'summary';
                            summaryLi.textContent = `Summary: ${data.summary.succeeded} succeeded, ${data.summary.failed} failed of ${data.summary.total} total`;
                            downloadList.appendChild(summaryLi);
                        }

                        // Show warnings for failed URLs
                        if (data.errors && data.errors.length > 0) {
                            warningDiv.style.display = 'block';
                            const failedUrls = data.errors.map(e => `${e.url}:\n  ${e.error}`).join('\n\n');
                            warningText.textContent = `${data.errors.length} URL(s) failed (may be rate limited - try again with fewer URLs):\n\n${failedUrls}`;
                        }

                        // Send browser notification
                        const notifyBody = data.summary
                            ? `${data.summary.succeeded} article${data.summary.succeeded !== 1 ? 's' : ''} converted`
                            : 'Your PDF is ready';
                        sendNotification('PDF Ready!', notifyBody);
                    } else if (data.type === 'error') {
                        statusDiv.style.display = 'none';
                        errorDiv.style.display = 'block';
                        errorText.textContent = data.error;
                        if (data.details) {
                            errorText.textContent += '\n\nDetails:\n' + data.details.map(d => `${d.url}: ${d.error}`).join('\n');
                        }
                    }
                }
            }
        }
    } catch (err) {
        console.error('Fetch error:', err);
        errorDiv.style.display = 'block';
        errorText.textContent = 'Failed to connect to server: ' + err.message;
    } finally {
        submitBtn.disabled = false;
        if (statusDiv.style.display !== 'none') {
            statusDiv.style.display = 'none';
        }
    }
});
</script>
{% endblock %}
