{% extends "base.html" %}

{% block title %}Setup Twitter Cookies{% endblock %}

{% block content %}
<h1>Setup Twitter Cookies</h1>
<p>To fetch content from Twitter/X, you need to provide your browser cookies.</p>

<section class="instructions">
    <h2>How to Get Your Cookies</h2>

    <h3>Option 1: Chrome / Edge / Brave</h3>
    <ol>
        <li>Log in to <a href="https://x.com" target="_blank">x.com</a> in your browser</li>
        <li>Open Developer Tools (<code>F12</code> or <code>Cmd+Option+I</code>)</li>
        <li>Go to the <strong>Application</strong> tab</li>
        <li>In the left sidebar, expand <strong>Cookies</strong> and click <code>https://x.com</code></li>
        <li>Find and copy these cookie values:
            <ul>
                <li><code>auth_token</code> - your authentication token</li>
                <li><code>ct0</code> - CSRF token</li>
            </ul>
        </li>
        <li>Format them as: <code>auth_token=YOUR_VALUE; ct0=YOUR_VALUE</code></li>
    </ol>

    <h3>Option 2: Firefox</h3>
    <ol>
        <li>Log in to <a href="https://x.com" target="_blank">x.com</a></li>
        <li>Open Developer Tools (<code>F12</code> or <code>Cmd+Option+I</code>)</li>
        <li>Go to the <strong>Storage</strong> tab</li>
        <li>Expand <strong>Cookies</strong> and click <code>https://x.com</code></li>
        <li>Find <code>auth_token</code> and <code>ct0</code>, copy their values</li>
    </ol>

    <h3>Option 3: Safari</h3>
    <ol>
        <li>First, enable Developer Tools: <strong>Safari → Settings → Advanced → Show Develop menu</strong></li>
        <li>Log in to <a href="https://x.com" target="_blank">x.com</a></li>
        <li>Open Developer Tools (<code>Cmd+Option+I</code>) or <strong>Develop → Show Web Inspector</strong></li>
        <li>Go to the <strong>Storage</strong> tab</li>
        <li>In the left sidebar, expand <strong>Cookies</strong> and click <code>x.com</code></li>
        <li>Find <code>auth_token</code> and <code>ct0</code> in the list</li>
        <li>Double-click each value to select it, then copy (<code>Cmd+C</code>)</li>
        <li>Format them as: <code>auth_token=YOUR_VALUE; ct0=YOUR_VALUE</code></li>
    </ol>

    <h3>Option 4: Browser Extension (Any Browser)</h3>
    <ol>
        <li>Install <a href="https://chrome.google.com/webstore/detail/editthiscookie" target="_blank">EditThisCookie</a> (Chrome) or <a href="https://addons.mozilla.org/firefox/addon/cookie-editor/" target="_blank">Cookie-Editor</a> (Firefox)</li>
        <li>Navigate to x.com while logged in</li>
        <li>Click the extension icon and find <code>auth_token</code> and <code>ct0</code></li>
        <li>Copy the values</li>
    </ol>
</section>

<section class="current-cookies">
    <h2>Current Cookies</h2>
    <div id="cookies-display" class="cookies-table">
        <p class="loading-text">Checking...</p>
    </div>
</section>

<section class="cookie-form">
    <h2>Enter New Cookies</h2>
    <p class="form-hint">Choose either format below - both work the same.</p>

    <div class="cookie-input-options">
        <div class="input-option">
            <h3>Option A: DevTools Copy-Paste</h3>
            <p class="option-hint">Select both cookie rows in DevTools and paste directly</p>
            <form id="cookie-form-devtools" class="cookie-form-inner">
                <textarea
                    id="cookie-input-devtools"
                    name="cookies"
                    rows="4"
                    placeholder="ct0    abc123...    .x.com    /    2026-01-01    163 B    ✓
auth_token    xyz789...    .x.com    /    2026-01-01    50 B    ✓    ✓"
                ></textarea>
                <button type="submit" class="save-btn">Save (DevTools Format)</button>
            </form>
        </div>

        <div class="input-option">
            <h3>Option B: Traditional Format</h3>
            <p class="option-hint">Manually format as name=value pairs</p>
            <form id="cookie-form-traditional" class="cookie-form-inner">
                <textarea
                    id="cookie-input-traditional"
                    name="cookies"
                    rows="4"
                    placeholder="auth_token=abc123...; ct0=xyz789..."
                ></textarea>
                <button type="submit" class="save-btn">Save (Traditional Format)</button>
            </form>
        </div>
    </div>

    <div class="button-group">
        <button type="button" id="test-cookies-btn" class="secondary">Test Cookies</button>
    </div>

    <div id="save-success" class="success-message" style="display: none;">
        Cookies saved successfully! You can now <a href="/">convert articles</a>.
    </div>
    <div id="save-error" class="error-message" style="display: none;"></div>

    <div id="test-status" class="status-message" style="display: none;">
        <span class="spinner"></span>
        <span id="test-status-text">Testing cookies...</span>
    </div>
    <div id="test-success" class="success-message" style="display: none;"></div>
    <div id="test-error" class="error-message" style="display: none;"></div>
</section>

<script>
// COOKIES_KEY is defined in base.html

// Helper to hide all result divs
function hideAllResults() {
    document.getElementById('save-success').style.display = 'none';
    document.getElementById('save-error').style.display = 'none';
    document.getElementById('test-status').style.display = 'none';
    document.getElementById('test-success').style.display = 'none';
    document.getElementById('test-error').style.display = 'none';
}

// Save cookies to localStorage
function handleCookieSubmit(e) {
    e.preventDefault();
    const form = e.target;
    const successDiv = document.getElementById('save-success');
    const errorDiv = document.getElementById('save-error');

    hideAllResults();

    const cookieValue = form.querySelector('textarea').value.trim();
    if (!cookieValue) {
        errorDiv.textContent = 'Please enter your cookies';
        errorDiv.style.display = 'block';
        return;
    }

    // Save to localStorage
    localStorage.setItem(COOKIES_KEY, cookieValue);
    successDiv.style.display = 'block';
    form.reset();

    // Refresh displays
    displayCurrentCookies();
    updateNavCookieStatus();
}

// Attach handler to both forms
document.getElementById('cookie-form-devtools').addEventListener('submit', handleCookieSubmit);
document.getElementById('cookie-form-traditional').addEventListener('submit', handleCookieSubmit);

// Test cookies by sending them to server for validation
document.getElementById('test-cookies-btn').addEventListener('click', async () => {
    const statusDiv = document.getElementById('test-status');
    const successDiv = document.getElementById('test-success');
    const errorDiv = document.getElementById('test-error');
    const testBtn = document.getElementById('test-cookies-btn');

    hideAllResults();

    const cookies = localStorage.getItem(COOKIES_KEY);
    if (!cookies) {
        errorDiv.textContent = 'No cookies saved. Please enter your cookies first.';
        errorDiv.style.display = 'block';
        return;
    }

    statusDiv.style.display = 'flex';
    testBtn.disabled = true;

    try {
        const response = await fetch('/api/cookies/validate', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({cookies: cookies})
        });
        const data = await response.json();

        statusDiv.style.display = 'none';

        if (data.valid) {
            successDiv.textContent = 'Cookies are valid! You can now convert Twitter articles.';
            successDiv.style.display = 'block';
        } else {
            errorDiv.textContent = data.message || 'Cookie validation failed';
            errorDiv.style.display = 'block';
        }

        updateNavCookieStatus();
    } catch (err) {
        statusDiv.style.display = 'none';
        errorDiv.textContent = 'Failed to connect to server';
        errorDiv.style.display = 'block';
    } finally {
        testBtn.disabled = false;
    }
});

// Display current cookies from localStorage
function displayCurrentCookies() {
    const display = document.getElementById('cookies-display');
    const cookies = localStorage.getItem(COOKIES_KEY);

    if (!cookies) {
        display.innerHTML = '<p class="no-cookies">No cookies saved yet.</p>';
        return;
    }

    // Parse and display masked cookies
    const parts = cookies.split(';').map(p => p.trim()).filter(p => p.includes('='));
    if (parts.length === 0) {
        display.innerHTML = '<p class="no-cookies">No valid cookies found.</p>';
        return;
    }

    const requiredNames = ['auth_token', 'ct0'];
    let html = '<table><thead><tr><th>Name</th><th>Value</th><th>Length</th><th>Status</th></tr></thead><tbody>';

    const cookieNames = [];
    for (const part of parts) {
        const eqIdx = part.indexOf('=');
        if (eqIdx === -1) continue;
        const name = part.substring(0, eqIdx).trim();
        const value = part.substring(eqIdx + 1).trim();
        cookieNames.push(name);

        // Mask value
        let masked;
        if (value.length > 12) {
            masked = value.substring(0, 4) + '...' + value.substring(value.length - 4);
        } else if (value.length > 4) {
            masked = value.substring(0, 2) + '...' + value.substring(value.length - 2);
        } else {
            masked = '****';
        }

        const isRequired = requiredNames.includes(name);
        const statusClass = isRequired ? 'status-ok' : 'status-extra';
        const statusText = isRequired ? 'Required' : 'Extra';

        html += `
            <tr>
                <td><code>${name}</code></td>
                <td><code class="masked-value">${masked}</code></td>
                <td>${value.length} chars</td>
                <td><span class="${statusClass}">${statusText}</span></td>
            </tr>
        `;
    }

    html += '</tbody></table>';

    const hasAuthToken = cookieNames.includes('auth_token');
    const hasCt0 = cookieNames.includes('ct0');

    if (!hasAuthToken || !hasCt0) {
        const missing = [];
        if (!hasAuthToken) missing.push('auth_token');
        if (!hasCt0) missing.push('ct0');
        html += `<p class="cookie-warning">Missing required cookies: <code>${missing.join('</code>, <code>')}</code></p>`;
    } else {
        html += '<p class="cookie-complete">All required cookies are set.</p>';
    }

    display.innerHTML = html;
}

// Display on page load
displayCurrentCookies();
</script>
{% endblock %}
